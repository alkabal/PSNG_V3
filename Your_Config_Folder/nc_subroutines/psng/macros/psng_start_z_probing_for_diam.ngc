o<psng_start_z_probing_for_diam> sub

#<_from_manual_change> = #1        ; call 1 = call from manual change for reset tool if error with probing
  M160    ;o<clear-axis-info> call

  M5 M9 ; stop spindle, mist+flood off
  o10 if [#<_hal[motion.probe-input]> EQ 1]
      (ABORT,!!! PROBE OR SETTER Z ALREADY TRIGGERED BEFORE PROBING !!!)
  o10 endif

;  o<psng_load_var_touch_probe> call

#<intial_X>=#<_x> (save start X position)

  G91
  G38.3 Z-#<_psng_maxprobe_z> F#<_psng_vel_for_search>
  o500 call

  o100 if [#<_psng_latch_maxprobe> GT 0]
       G38.5 Z#<_psng_latch_maxprobe> F[#<_psng_vel_for_search>*0.5]     ; DO NOT WORK FINE WITHOUT SPRING MOUNTED SETTER
       o500 call
  o100 endif

  ; Move away
  G1    Z#<_psng_latch> F#<_psng_vel_for_search>

  ; Start final prove
  G38.3 Z-[#<_psng_latch>*1.5] F#<_psng_vel_for_probe>                  ; *1.3 in cas of use reverse latch we need to move more than regular latch
  o500 call

  #<_psng_touch_result_Z> = #5063

  G38.5 X-#<_psng_maxprobe_xy> F[#<_psng_vel_for_search>*0.5]     ; move X away from workpieces
  o500 call

  #<_psng_touch_result_approximative_radius> = [#<intial_X> - #5062]
  (print, Probed approximative radius = #<_psng_touch_result_approximative_radius>)
  
  G90

o500 sub
     o510 if [#5070 EQ 0 AND #<_from_manual_change> EQ 1] ; call 1 = call from manual change for reset tool if error with probing
          M61Q0           ; reset the tool number
          (ABORT,TOOLSETTER Z DOES NOT FOUND THE CONTACT POINT)
     o510 elseif  [#5070 EQ 0 AND #<_from_manual_change> EQ 0]
          (ABORT,3D PROBE OR SETTER Z DOES NOT FOUND THE CONTACT POINT)
     o510 endif
o500 endsub

o<psng_start_z_probing_for_diam> endsub
M2
